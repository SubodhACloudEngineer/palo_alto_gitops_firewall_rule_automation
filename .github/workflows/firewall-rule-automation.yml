name: Palo Alto Firewall Rule Automation

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'firewall-rules/**'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'firewall-rules/**'
  workflow_dispatch:
    inputs:
      rule_file:
        description: 'Specific rule file to deploy (leave empty for all changed rules)'
        required: false
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Dry run mode (validation only)'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================
  # STAGE 1: Detect Changed Rules
  # ============================================
  detect-changes:
    name: Detect Changed Rules
    runs-on: ubuntu-latest
    outputs:
      rules_changed: ${{ steps.changes.outputs.rules }}
      rule_files: ${{ steps.get-files.outputs.files }}
      rule_count: ${{ steps.get-files.outputs.count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for firewall rule changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            rules:
              - 'firewall-rules/**/*.json'
              - 'firewall-rules/**/*.yaml'
              - 'firewall-rules/**/*.yml'

      - name: Get changed rule files
        id: get-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'firewall-rules/*.json' 'firewall-rules/*.yaml' 'firewall-rules/*.yml' 2>/dev/null | grep -v -i template | grep -v -i example | grep -v -i sample | tr '\n' ' ' || true)
          else
            FILES=$(git diff --name-only HEAD~1 -- 'firewall-rules/*.json' 'firewall-rules/*.yaml' 'firewall-rules/*.yml' 2>/dev/null | grep -v -i template | grep -v -i example | grep -v -i sample | tr '\n' ' ' || true)
          fi

          # Trim whitespace
          FILES=$(echo "$FILES" | xargs)

          if [ -z "$FILES" ]; then
            echo "No changed rule files detected"
            COUNT=0
          else
            COUNT=$(echo "$FILES" | wc -w)
          fi

          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Changed rule files: $FILES"
          echo "Total count: $COUNT"

  # ============================================
  # STAGE 2: Schema Validation
  # ============================================
  validate-schema:
    name: Validate JSON Schema
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.rule_count != '0' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml

      - name: Get changed rule files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'firewall-rules/*.json' 2>/dev/null | grep -v -i template | grep -v -i example | grep -v -i sample | tr '\n' ' ' || true)
          else
            FILES=$(git diff --name-only HEAD~1 -- 'firewall-rules/*.json' 2>/dev/null | grep -v -i template | grep -v -i example | grep -v -i sample | tr '\n' ' ' || true)
          fi
          FILES=$(echo "$FILES" | xargs)
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"

      - name: Validate firewall rules against schema
        run: |
          echo "Validating firewall rules against JSON schema..."
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"

          if [ -n "$CHANGED_FILES" ]; then
            echo "Validating changed files only: $CHANGED_FILES"
            python scripts/validate_schema.py $CHANGED_FILES
          else
            echo "No changed rule files detected, skipping validation"
          fi

          echo "Schema validation completed successfully"

  # ============================================
  # STAGE 3: Security Policy Validation
  # ============================================
  validate-security:
    name: Security Policy Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.rule_count != '0' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ipaddress pyyaml

      - name: Run security policy validation
        run: |
          echo "Running security policy validation..."
          if [ -f "scripts/validate_security.py" ]; then
            python scripts/validate_security.py
          else
            echo "Security validation script not found, skipping"
          fi
          echo "Security validation completed"

  # ============================================
  # STAGE 4: IP Address and Network Validation
  # ============================================
  validate-network:
    name: Network Configuration Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.rule_count != '0' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ipaddress netaddr pyyaml

      - name: Validate network configurations
        run: |
          echo "Validating IP addresses and network configurations..."
          if [ -f "scripts/validate_network.py" ]; then
            python scripts/validate_network.py
          else
            echo "Network validation script not found, skipping"
          fi
          echo "Network validation completed"

  # ============================================
  # STAGE 5: Dry Run Deployment Test
  # ============================================
  dry-run:
    name: Dry Run Deployment
    runs-on: ubuntu-latest
    needs: [validate-schema, validate-security, validate-network]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Execute dry-run deployment
        run: |
          echo "Executing dry-run deployment..."
          echo "================================================"
          echo "DRY RUN MODE - No actual changes will be made"
          echo "================================================"

          # Find rule files (excluding templates)
          RULE_FILES=$(find firewall-rules -name "*.json" -type f | grep -v -i template | grep -v -i example | grep -v -i sample || true)

          if [ -z "$RULE_FILES" ]; then
            echo "No rule files found to validate"
            exit 0
          fi

          for rule_file in $RULE_FILES; do
            echo ""
            echo "Processing: $rule_file"
            echo "----------------------------------------"
            python scripts/deploy_rule.py "$rule_file" --dry-run
          done

          echo ""
          echo "================================================"
          echo "Dry run completed successfully"
          echo "================================================"

      - name: Generate deployment preview
        run: |
          echo "## Deployment Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find rule files (excluding templates)
          RULE_FILES=$(find firewall-rules -name "*.json" -type f | grep -v -i template | grep -v -i example | grep -v -i sample || true)

          if [ -z "$RULE_FILES" ]; then
            echo "No rule files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          for rule_file in $RULE_FILES; do
            rule_name=$(python -c "import json; print(json.load(open('$rule_file')).get('rule_name', 'Unknown'))" 2>/dev/null || echo "Unknown")
            action=$(python -c "import json; print(json.load(open('$rule_file')).get('action', 'unknown').upper())" 2>/dev/null || echo "UNKNOWN")
            src=$(python -c "import json; print(', '.join(json.load(open('$rule_file')).get('source_address', ['N/A'])))" 2>/dev/null || echo "N/A")
            dst=$(python -c "import json; print(', '.join(json.load(open('$rule_file')).get('destination_address', ['N/A'])))" 2>/dev/null || echo "N/A")

            echo "### Rule: $rule_name" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** $action" >> $GITHUB_STEP_SUMMARY
            echo "- **Source:** $src" >> $GITHUB_STEP_SUMMARY
            echo "- **Destination:** $dst" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

  # ============================================
  # STAGE 6: Integration Tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: dry-run
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov jsonschema pyyaml ipaddress

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          if [ -d "tests" ] && [ -n "$(ls -A tests/*.py 2>/dev/null)" ]; then
            python -m pytest tests/ -v --tb=short || true
          else
            echo "No tests found, skipping"
          fi
          echo "Integration tests completed"

  # ============================================
  # STAGE 7: Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging-firewall.internal
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Deploy firewall rules to staging
        env:
          PA_FIREWALL_IP: ${{ secrets.STAGING_FIREWALL_IP }}
          PA_USERNAME: ${{ secrets.PA_USERNAME }}
          PA_PASSWORD: ${{ secrets.PA_PASSWORD }}
          PA_API_KEY: ${{ secrets.PA_API_KEY }}
        run: |
          echo "Deploying firewall rules to STAGING environment..."
          echo "================================================"
          echo "Target Firewall: ${PA_FIREWALL_IP:-'Not configured'}"
          echo "Deployment Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "================================================"

          if [ -z "$PA_FIREWALL_IP" ]; then
            echo "WARNING: PA_FIREWALL_IP not configured. Running in dry-run mode."
            python scripts/deploy_rule.py --dry-run --environment staging --all
          else
            python scripts/deploy_rule.py --environment staging --all
          fi

      - name: Generate staging deployment report
        run: |
          echo "## Staging Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "Deployment completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 8: Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'))
    environment:
      name: production
      url: https://firewall.internal
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Deploy firewall rules to production
        env:
          PA_FIREWALL_IP: ${{ secrets.PROD_FIREWALL_IP }}
          PA_USERNAME: ${{ secrets.PA_USERNAME }}
          PA_PASSWORD: ${{ secrets.PA_PASSWORD }}
          PA_API_KEY: ${{ secrets.PA_API_KEY }}
        run: |
          echo "Deploying firewall rules to PRODUCTION environment..."
          echo "================================================"
          echo "Target Firewall: ${PA_FIREWALL_IP:-'Not configured'}"
          echo "Deployment Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Deployed By: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "================================================"

          if [ -z "$PA_FIREWALL_IP" ]; then
            echo "WARNING: PA_FIREWALL_IP not configured. Running in dry-run mode."
            python scripts/deploy_rule.py --dry-run --environment production --all
          else
            python scripts/deploy_rule.py --environment production --all
          fi

      - name: Generate production deployment report
        run: |
          echo "## Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 9: Post-Deployment Notifications
  # ============================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Notify on success
        if: needs.deploy-production.result == 'success'
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Firewall rules have been successfully deployed to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Firewall rule deployment to production has failed." >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY

      - name: Create deployment issue on failure
        if: needs.deploy-production.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Firewall Deployment Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Deployment Failure Report\n\n**Workflow:** ${context.workflow}\n**Run ID:** ${context.runId}\n**Triggered by:** ${context.actor}\n**Commit:** ${context.sha}\n\nPlease investigate the failed deployment.`,
              labels: ['deployment-failure', 'firewall']
            })
